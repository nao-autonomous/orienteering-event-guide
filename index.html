<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#16a34a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ã‚¤ãƒ™ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰</title>
<link rel="manifest" href="manifest.json">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RMMPL6QL06"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-RMMPL6QL06');</script>
<style>
/* ========== Reset & Base ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --green: #16a34a;
  --green-light: #dcfce7;
  --green-dark: #15803d;
  --green-50: #f0fdf4;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --red: #dc2626;
  --amber: #f59e0b;
  --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.06);
  --radius: 8px;
  --radius-lg: 12px;
  --nav-height: 56px;
  --topbar-height: 44px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans",
               "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  color: var(--gray-800);
  background: var(--gray-50);
  line-height: 1.6;
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
}
html { overscroll-behavior: none; }

/* ========== App Shell ========== */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  height: 100dvh;
}

.topbar {
  background: white;
  border-bottom: 1px solid var(--gray-200);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: var(--topbar-height);
  flex-shrink: 0;
}

.topbar-title {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--gray-700);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}

.day-selector {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  margin-left: 8px;
}

.day-btn {
  padding: 2px 10px;
  border: 1px solid var(--gray-300);
  border-radius: 4px;
  background: white;
  font-size: 0.75rem;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.15s;
}

.day-btn.active {
  background: var(--green);
  color: white;
  border-color: var(--green);
}

.content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px 16px 16px;
}

/* ========== Bottom Nav ========== */
.bottom-nav {
  display: flex;
  background: white;
  border-top: 1px solid var(--gray-200);
  height: var(--nav-height);
  flex-shrink: 0;
  padding-bottom: env(safe-area-inset-bottom, 0);
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  border: none;
  background: none;
  cursor: pointer;
  color: var(--gray-400);
  font-size: 0.65rem;
  padding: 4px 0;
  transition: color 0.15s;
}

.nav-item.active {
  color: var(--green);
}

.nav-item .nav-icon {
  font-size: 1.25rem;
  line-height: 1;
}

/* ========== Tab Panels ========== */
.tab-panel { display: none; }
.tab-panel.active { display: block; }

/* ========== Hero Card ========== */
.hero-card {
  background: linear-gradient(135deg, var(--green), var(--green-dark));
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  color: white;
  margin-bottom: 16px;
  box-shadow: var(--shadow-md);
}

.hero-card .hero-title {
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.hero-card .hero-divider {
  height: 1px;
  background: rgba(255,255,255,0.3);
  margin: 8px 0;
}

.hero-card .hero-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 4px 0;
  font-size: 0.85rem;
}

.hero-card .hero-row .label {
  opacity: 0.85;
  font-size: 0.8rem;
}

.hero-card .hero-row .value {
  font-weight: 600;
  font-size: 1rem;
}

.hero-card .hero-row .value .sub {
  font-size: 0.75rem;
  font-weight: 400;
  opacity: 0.8;
  margin-left: 4px;
}

.hero-card .hero-footer {
  font-size: 0.78rem;
  opacity: 0.85;
  margin-top: 4px;
  text-align: center;
}

/* ========== Hero Card: Start Area ========== */
.hero-section-title {
  font-size: 0.8rem;
  font-weight: 600;
  opacity: 0.9;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.hero-description {
  font-size: 0.78rem;
  opacity: 0.85;
  line-height: 1.5;
  margin-bottom: 4px;
}
.hero-steps {
  font-size: 0.78rem;
  opacity: 0.9;
  line-height: 1.5;
  padding-left: 4px;
}
.hero-steps .step {
  padding: 2px 0;
}

/* ========== Event Selection Cards ========== */
.event-select-title {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 12px;
  text-align: center;
}
.event-card {
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-lg);
  padding: 16px 20px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.event-card:active {
  background: var(--green);
  border-color: var(--green);
  color: white;
}
.event-card:active .event-card-date { color: rgba(255,255,255,0.85); }
.event-card-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 4px;
}
.event-card-date {
  font-size: 0.8rem;
  color: var(--gray-500);
}
.event-card-badge {
  display: inline-block;
  font-size: 0.7rem;
  background: var(--green);
  color: white;
  border-radius: 4px;
  padding: 1px 6px;
  margin-left: 6px;
  vertical-align: middle;
}

/* ========== Search ========== */
.search-box {
  position: relative;
  margin-bottom: 12px;
}

.search-box input {
  width: 100%;
  padding: 10px 12px 10px 36px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius);
  font-size: 0.9rem;
  background: white;
  outline: none;
  transition: border-color 0.15s;
}

.search-box input:focus {
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(22,163,74,0.1);
}

.search-box .search-icon {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1rem;
  color: var(--gray-400);
}

.search-results {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  max-height: 180px;
  overflow-y: auto;
  margin-bottom: 12px;
  box-shadow: var(--shadow);
}

.search-results.hidden { display: none; }

.search-result-item {
  padding: 8px 12px;
  border-bottom: 1px solid var(--gray-100);
  cursor: pointer;
  font-size: 0.85rem;
  transition: background 0.1s;
}

.search-result-item:last-child { border-bottom: none; }
.search-result-item:active { background: var(--green-light); }

.search-result-item .name { font-weight: 600; }
.search-result-item .detail {
  font-size: 0.75rem;
  color: var(--gray-500);
  margin-top: 2px;
}

/* ========== Timeline ========== */
.timeline {
  position: relative;
  padding-left: 72px;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 60px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--gray-200);
}

.timeline-item {
  position: relative;
  padding: 8px 0 16px;
}

.timeline-item .time {
  position: absolute;
  left: -72px;
  top: 8px;
  width: 52px;
  text-align: right;
  font-size: 0.8rem;
  font-weight: 700;
  color: var(--gray-700);
}

.timeline-item .dot {
  position: absolute;
  left: -16px;
  top: 12px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--green);
  border: 2px solid white;
  box-shadow: 0 0 0 1px var(--gray-200);
}

.timeline-item .dot.cat-start { background: var(--red); }
.timeline-item .dot.cat-reception { background: var(--amber); }
.timeline-item .dot.cat-general { background: var(--green); }
.timeline-item .dot.cat-facility { background: #8b5cf6; }
.timeline-item .dot.cat-personal { background: #2563eb; }

.timeline-item .tl-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--gray-800);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.timeline-item .tl-label .expand-icon {
  font-size: 0.7rem;
  color: var(--gray-400);
  transition: transform 0.2s;
}

.timeline-item .tl-label .expand-icon.open {
  transform: rotate(90deg);
}

.timeline-item .tl-details {
  display: none;
  font-size: 0.82rem;
  color: var(--gray-700);
  margin-top: 6px;
  padding: 8px 10px;
  line-height: 1.75;
  background: var(--gray-50);
  border-radius: 6px;
  word-break: break-word;
}

.timeline-item .tl-details.open { display: block; }

.now-marker {
  position: absolute;
  left: -4px;
  right: 0;
  height: 2px;
  background: var(--red);
  z-index: 10;
}

.now-marker::before {
  content: 'Now';
  position: absolute;
  left: -48px;
  top: -8px;
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--red);
  background: white;
  padding: 0 4px;
  border-radius: 2px;
}

/* ========== Accordion ========== */
.accordion { margin-bottom: 8px; }

.accordion-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--gray-700);
  width: 100%;
  text-align: left;
  transition: background 0.1s;
}

.accordion-header:active { background: var(--gray-50); }

.accordion-header .acc-icon { font-size: 1rem; }
.accordion-header .acc-arrow {
  margin-left: auto;
  font-size: 0.7rem;
  color: var(--gray-400);
  transition: transform 0.2s;
}

.accordion-header.open { border-radius: var(--radius) var(--radius) 0 0; }
.accordion-header.open .acc-arrow { transform: rotate(180deg); }

.accordion-body {
  display: none;
  padding: 16px 20px;
  background: white;
  border: 1px solid var(--gray-200);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
  font-size: 0.88rem;
  color: var(--gray-700);
  line-height: 1.85;
  word-break: break-word;
}

.accordion-body.open { display: block; }

/* ========== Course Table ========== */
.course-table-wrap {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin: 0 -16px;
  padding: 0 16px;
}

.course-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
  min-width: 340px;
}

.course-table th {
  background: var(--green);
  color: white;
  padding: 8px 10px;
  text-align: left;
  font-weight: 600;
  font-size: 0.75rem;
  white-space: nowrap;
}

.course-table td {
  padding: 8px 10px;
  border-bottom: 1px solid var(--gray-200);
  white-space: nowrap;
}

.course-table tr:nth-child(even) { background: var(--gray-50); }
.course-table tr.highlight { background: var(--green-light); font-weight: 600; }

/* ========== Settings ========== */
.setting-group {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  margin-bottom: 12px;
}

.setting-group .setting-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
}

.setting-group select,
.setting-group input[type="text"] {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius);
  font-size: 0.9rem;
  background: white;
  outline: none;
}

.setting-group select:focus,
.setting-group input[type="text"]:focus {
  border-color: var(--green);
}

.radio-group {
  display: flex;
  gap: 12px;
}

.radio-group label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85rem;
  cursor: pointer;
}

.radio-group input[type="radio"] { accent-color: var(--green); }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.15s;
}

.btn:active { opacity: 0.7; }

.btn-green {
  background: var(--green);
  color: white;
}

.btn-outline {
  background: white;
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
}

.btn-sm { padding: 4px 12px; font-size: 0.8rem; }

.meta-text {
  font-size: 0.78rem;
  color: var(--gray-500);
  margin-top: 4px;
}

.status-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 4px;
}

.status-dot.online { background: var(--green); }
.status-dot.offline { background: var(--gray-400); }

.participant-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--green-light);
  color: var(--green-dark);
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

/* ========== Loading ========== */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 16px;
  color: var(--gray-500);
  font-size: 0.85rem;
  gap: 12px;
}

.spinner {
  width: 28px;
  height: 28px;
  border: 3px solid var(--gray-200);
  border-top-color: var(--green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ========== Empty State ========== */
.empty-state {
  text-align: center;
  padding: 32px 16px;
  color: var(--gray-400);
  font-size: 0.85rem;
}

.empty-state .empty-icon {
  font-size: 2rem;
  margin-bottom: 8px;
}

/* ========== Utilities ========== */
.hidden { display: none !important; }
.mb-8 { margin-bottom: 8px; }
.mb-12 { margin-bottom: 12px; }
.mb-16 { margin-bottom: 16px; }
.text-center { text-align: center; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }

@media (min-width: 640px) {
  .content { padding: 16px 24px 24px; }
  .hero-card { padding: 20px 24px; }
  .course-table { font-size: 0.85rem; }
}
</style>
</head>
<body>
<div id="app">
  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div class="day-selector hidden" id="day-selector"></div>
  </div>

  <!-- Content Area -->
  <div class="content" id="content">
    <!-- Tab: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <div class="tab-panel active" id="tab-timeline">
      <div id="timeline-content">
        <div class="empty-state">
          <div class="empty-icon">ğŸ§­</div>
          <div>è¨­å®šã‚¿ãƒ–ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>

    <!-- Tab: æƒ…å ± -->
    <div class="tab-panel" id="tab-info">
      <div id="info-content">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“‹</div>
          <div>ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>

    <!-- Tab: ã‚³ãƒ¼ã‚¹ -->
    <div class="tab-panel" id="tab-courses">
      <div id="courses-content">
        <div class="empty-state">
          <div class="empty-icon">ğŸ—ºï¸</div>
          <div>ã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>

    <!-- Tab: è¨­å®š -->
    <div class="tab-panel" id="tab-settings">
      <div id="settings-content"></div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-tab="timeline">
      <span class="nav-icon">â±</span>
      <span>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span>
    </button>
    <button class="nav-item" data-tab="info">
      <span class="nav-icon">â„¹ï¸</span>
      <span>æƒ…å ±</span>
    </button>
    <button class="nav-item" data-tab="courses">
      <span class="nav-icon">ğŸ—ºï¸</span>
      <span>ã‚³ãƒ¼ã‚¹</span>
    </button>
    <button class="nav-item" data-tab="settings">
      <span class="nav-icon">âš™ï¸</span>
      <span>è¨­å®š</span>
    </button>
  </nav>
</div>

<script>
/* ========== Constants ========== */
const CDN_BASE = 'https://nao-autonomous.github.io/orienteering-event-guide/data/';
const DB_NAME = 'event-guide-db';
const DB_VERSION = 1;
const APP_VERSION = '1.4.0';

/* ========== State ========== */
const state = {
  events: null,       // index.json contents
  eventData: null,    // current event data
  startlist: null,    // current startlist
  selectedEvent: null,
  selectedDay: 1,
  selectedParticipant: null,
  db: null,
  isLocal: new URLSearchParams(location.search).has('local'),
};

/* ========== IndexedDB ========== */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('events')) db.createObjectStore('events');
      if (!db.objectStoreNames.contains('startlists')) db.createObjectStore('startlists');
      if (!db.objectStoreNames.contains('meta')) db.createObjectStore('meta');
    };
    req.onsuccess = () => { state.db = req.result; resolve(req.result); };
    req.onerror = () => reject(req.error);
  });
}

function dbGet(store, key) {
  return new Promise((resolve, reject) => {
    const tx = state.db.transaction(store, 'readonly');
    const req = tx.objectStore(store).get(key);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

function dbPut(store, key, value) {
  return new Promise((resolve, reject) => {
    const tx = state.db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put(value, key);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
  });
}

/* ========== Data Loading ========== */
async function fetchJSON(path) {
  const url = state.isLocal ? `./${path}` : `${CDN_BASE}${path}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${url}`);
  return res.json();
}

async function checkConnectivity() {
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000);
    const res = await fetch(CDN_BASE + 'index.json', {
      method: 'HEAD', cache: 'no-store', signal: controller.signal
    });
    clearTimeout(timeout);
    return res.ok;
  } catch {
    return false;
  }
}

async function loadIndex() {
  try {
    const data = await fetchJSON('index.json');
    state.events = data;
    await dbPut('meta', 'index', data);
    return data;
  } catch (e) {
    const cached = await dbGet('meta', 'index');
    if (cached) { state.events = cached; return cached; }
    throw e;
  }
}

async function loadEventData(eventId) {
  try {
    const event = state.events.events.find(e => e.id === eventId);
    if (!event) throw new Error(`Event not found: ${eventId}`);

    const data = await fetchJSON(event.file);
    state.eventData = data;
    await dbPut('events', eventId, data);

    if (event.startlist) {
      try {
        const sl = await fetchJSON(event.startlist);
        state.startlist = sl;
        await dbPut('startlists', eventId, sl);
      } catch (e2) {
        const cachedSl = await dbGet('startlists', eventId);
        state.startlist = cachedSl || null;
      }
    } else {
      state.startlist = null;
    }

    await dbPut('meta', 'last_updated', new Date().toISOString());
    return data;
  } catch (e) {
    const cached = await dbGet('events', eventId);
    if (cached) {
      state.eventData = cached;
      const cachedSl = await dbGet('startlists', eventId);
      state.startlist = cachedSl || null;
      return cached;
    }
    throw e;
  }
}

/* ========== Time Utilities ========== */
function formatEventDate(dateStr) {
  if (!dateStr) return '';
  const parts = dateStr.split('/');
  const fmt = d => {
    const dt = new Date(d + 'T00:00:00');
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    return `${dt.getFullYear()}å¹´${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥(${days[dt.getDay()]})`;
  };
  if (parts.length === 2) return `${fmt(parts[0])} ã€œ ${fmt(parts[1])}`;
  return fmt(parts[0]);
}

function parseTime(str) {
  if (!str) return null;
  const m = str.match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return null;
  return { h: parseInt(m[1], 10), m: parseInt(m[2], 10) };
}

function formatTime(h, m) {
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function timeToMinutes(t) {
  return t ? t.h * 60 + t.m : null;
}

function minutesToTime(mins) {
  return { h: Math.floor(mins / 60), m: mins % 60 };
}

function calculateDepartureTime(startTimeStr, walkMinutes) {
  const t = parseTime(startTimeStr);
  if (!t || !walkMinutes) return null;
  const total = timeToMinutes(t) - walkMinutes;
  const dep = minutesToTime(total < 0 ? total + 1440 : total);
  return formatTime(dep.h, dep.m);
}

function getCurrentTimePosition(timelineItems) {
  const now = new Date();
  const nowMins = now.getHours() * 60 + now.getMinutes();
  if (!timelineItems.length) return null;

  const times = timelineItems.map(item => timeToMinutes(parseTime(item.time))).filter(t => t !== null);
  const minT = Math.min(...times);
  const maxT = Math.max(...times);

  if (nowMins < minT - 30 || nowMins > maxT + 60) return null;
  return nowMins;
}

/* ========== Participant Search ========== */
function searchParticipant(query, startlist) {
  if (!query || !startlist || !startlist.participants) return [];
  const q = query.toLowerCase().trim();
  if (!q) return [];

  return startlist.participants.filter(p => {
    const name = (p.name || '').toLowerCase();
    const kana = (p.kana || p.furigana || '').toLowerCase();
    const club = (p.club || p.team || '').toLowerCase();
    return name.includes(q) || kana.includes(q) || club.includes(q);
  }).slice(0, 20);
}

function selectParticipant(participant) {
  state.selectedParticipant = participant;
  localStorage.setItem('selected_participant', JSON.stringify(participant));
  renderCurrentTab();
}

function clearParticipant() {
  state.selectedParticipant = null;
  localStorage.removeItem('selected_participant');
  renderCurrentTab();
  renderSettings();
}

function renderHeroStartArea(eventData, day) {
  const sa = eventData.start_area;
  if (!sa) return '';
  // Support per-day start_area (e.g., {day1: {...}, day2: {...}}) or flat
  const areaData = sa[`day${day}`] || sa;
  if (!areaData.description && !areaData.steps) return '';

  let html = '<div class="hero-divider"></div>';
  if (areaData.description) {
    html += `<div class="hero-section-title">ğŸ“ ã‚¹ã‚¿ãƒ¼ãƒˆã¾ã§</div>`;
    html += `<div class="hero-description">${escapeHtml(areaData.description)}</div>`;
  }
  if (areaData.steps && areaData.steps.length) {
    html += `<div class="hero-section-title">ğŸ ã‚¹ã‚¿ãƒ¼ãƒˆæ‰‹é †</div>`;
    html += '<div class="hero-steps">';
    areaData.steps.forEach(s => {
      html += `<div class="step">${escapeHtml(s)}</div>`;
    });
    html += '</div>';
  }
  return html;
}

/* ========== Rendering: Timeline Tab ========== */
function renderTimeline(eventData, day, participant) {
  const container = document.getElementById('timeline-content');
  if (!eventData) {
    // Show event selection cards instead of just a message
    const events = state.events?.events || [];
    if (events.length > 0) {
      let cardsHtml = '<div class="event-select-title">ğŸ§­ ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ</div>';
      events.forEach(e => {
        const dateStr = formatEventDate(e.date);
        const hasSL = e.startlist ? '<span class="event-card-badge">ã‚¹ã‚¿ãƒ¼ãƒˆãƒªã‚¹ãƒˆ</span>' : '';
        cardsHtml += `
          <div class="event-card" onclick="onEventChange('${e.id}')">
            <div class="event-card-name">${escapeHtml(e.name)}${hasSL}</div>
            <div class="event-card-date">${dateStr}</div>
          </div>`;
      });
      container.innerHTML = cardsHtml;
    } else {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ§­</div>
          <div>è¨­å®šã‚¿ãƒ–ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>`;
    }
    return;
  }

  // Support both nested days[] array and flat timeline with day field
  const dayData = Array.isArray(eventData.days) ? eventData.days[day - 1] : eventData;
  if (!dayData) {
    container.innerHTML = '<div class="empty-state"><div>ã“ã®æ—¥ç¨‹ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }

  // Resolve start_walk_minutes (could be number or {day1:N, day2:N})
  const swm = dayData.start_walk_minutes || eventData.start_walk_minutes;
  const walkMinsForDay = (typeof swm === 'object' && swm !== null)
    ? (swm[`day${day}`] || swm.day1 || 30)
    : (swm || 30);

  let html = '';

  // Participant search (if startlist available)
  if (state.startlist) {
    html += `
      <div class="search-box mb-12">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="participant-search" placeholder="åå‰ãƒ»ãµã‚ŠãŒãªãƒ»æ‰€å±ã§æ¤œç´¢"
               value="" autocomplete="off">
      </div>
      <div class="search-results hidden" id="search-results"></div>`;
  }

  // Hero card
  if (participant) {
    const startTime = participant.start_time || '';
    const walkMins = walkMinsForDay;
    const departTime = calculateDepartureTime(startTime, walkMins);
    const receptionTime = dayData.reception_time || eventData.reception_time || '';

    html += `
      <div class="hero-card">
        <div class="hero-title">ğŸƒ ã‚ãªãŸã®ã‚¹ã‚¿ãƒ¼ãƒˆ</div>
        <div class="hero-divider"></div>
        <div class="hero-row">
          <span class="label">ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
          <span class="value">${startTime || 'â€”'}</span>
        </div>
        ${departTime ? `
        <div class="hero-row">
          <span class="label">å‡ºç™º</span>
          <span class="value">${departTime}<span class="sub">(${walkMins}åˆ†å‰)</span></span>
        </div>` : ''}
        ${receptionTime ? `
        <div class="hero-row">
          <span class="label">å—ä»˜</span>
          <span class="value">${receptionTime}</span>
        </div>` : ''}
        ${renderHeroStartArea(eventData, day)}
        <div class="hero-divider"></div>
        <div class="hero-footer">
          ${participant.name || ''}${(participant.class_name || participant['class']) ? ' / ' + (participant.class_name || participant['class']) : ''}${participant.club || participant.team ? ' / ' + (participant.club || participant.team) : ''}
        </div>
      </div>`;
  }

  // Timeline items â€” filter by day if flat structure
  const rawTimeline = dayData.timeline || [];
  const timelineItems = Array.isArray(eventData.days) ? rawTimeline : rawTimeline.filter(t => !t.day || t.day === day);
  if (timelineItems.length) {
    const nowMins = getCurrentTimePosition(timelineItems);

    html += '<div class="timeline" id="timeline-list">';

    // Sort by time
    const sorted = [...timelineItems].sort((a, b) => {
      const ta = timeToMinutes(parseTime(a.time));
      const tb = timeToMinutes(parseTime(b.time));
      return (ta || 0) - (tb || 0);
    });

    let nowInserted = false;

    sorted.forEach((item, i) => {
      const itemMins = timeToMinutes(parseTime(item.time));
      const nextItem = sorted[i + 1];
      const nextMins = nextItem ? timeToMinutes(parseTime(nextItem.time)) : null;

      const cat = item.category || 'general';
      const hasDetails = item.details && item.details.trim();

      html += `
        <div class="timeline-item">
          <span class="time">${item.time || ''}</span>
          <span class="dot cat-${cat}"></span>
          <div class="tl-label" ${hasDetails ? 'onclick="toggleDetails(this)"' : ''}>
            ${item.label || ''}
            ${hasDetails ? '<span class="expand-icon">â–¶</span>' : ''}
          </div>
          ${hasDetails ? `<div class="tl-details">${formatInfoText(escapeHtml(item.details))}</div>` : ''}
        </div>`;

      // Insert now marker
      if (nowMins !== null && !nowInserted && itemMins !== null) {
        if (nowMins >= itemMins && (nextMins === null || nowMins < nextMins)) {
          html += `<div class="now-marker" style="top: auto; position: relative; margin: -8px 0 8px -4px;"></div>`;
          nowInserted = true;
        }
      }
    });

    html += '</div>';
  } else {
    html += '<div class="empty-state"><div>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
  }

  container.innerHTML = html;

  // Attach search handler
  const searchInput = document.getElementById('participant-search');
  if (searchInput) {
    if (participant) {
      searchInput.value = participant.name || '';
    }
    searchInput.addEventListener('input', handleSearch);
  }
}

function handleSearch(e) {
  const query = e.target.value;
  const resultsEl = document.getElementById('search-results');
  if (!query.trim()) {
    resultsEl.classList.add('hidden');
    resultsEl.innerHTML = '';
    return;
  }

  const results = searchParticipant(query, state.startlist);
  if (!results.length) {
    resultsEl.classList.add('hidden');
    return;
  }

  resultsEl.classList.remove('hidden');
  resultsEl.innerHTML = results.map((p, i) => `
    <div class="search-result-item" onclick="onSelectResult(${i})">
      <div class="name">${escapeHtml(p.name || '')}</div>
      <div class="detail">${escapeHtml(p.class_name || p['class'] || '')} / ${escapeHtml(p.club || p.team || '')} / ${p.start_time || 'â€”'}</div>
    </div>`).join('');

  // Store results for selection
  resultsEl._results = results;
}

function onSelectResult(index) {
  const resultsEl = document.getElementById('search-results');
  const p = resultsEl._results && resultsEl._results[index];
  if (p) {
    selectParticipant(p);
    resultsEl.classList.add('hidden');
  }
}

function toggleDetails(el) {
  const details = el.nextElementSibling;
  const icon = el.querySelector('.expand-icon');
  if (details) {
    details.classList.toggle('open');
    if (icon) icon.classList.toggle('open');
  }
}

/* ========== Rendering: Info Tab ========== */
function formatInfoText(text, day) {
  let processed = text
    .replace(/ã€‚/g, 'ã€‚\n')
    .replace(/\n{2,}/g, '\n')
    .trim()
    .split('\n')
    .map(line => `<p style="margin:0 0 6px">${line}</p>`)
    .join('')
    .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:var(--green);word-break:break-all">$1</a>');

  // Highlight current day, dim other days
  if (day) {
    const dayLabel = `Day${day}`;
    const otherDays = [1,2,3].filter(d => d !== day).map(d => `Day${d}`);
    // Dim paragraphs mentioning other days
    otherDays.forEach(od => {
      processed = processed.replace(
        new RegExp(`(<p[^>]*>)((?:(?!<\/p>).)*${od}(?:(?!<\/p>).)*)(<\/p>)`, 'gi'),
        '$1<span style="opacity:0.35">$2</span>$3'
      );
    });
    // Highlight current day
    processed = processed.replace(
      new RegExp(`(${dayLabel}[^<]*)`, 'gi'),
      '<strong style="color:var(--green-dark)">$1</strong>'
    );
  }
  return processed;
}

function renderInfo(eventData, day) {
  const container = document.getElementById('info-content');
  if (!eventData || !eventData.info) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div>æƒ…å ±ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }

  const daysField = eventData.days || eventData.event?.days;
  const dayCount = Array.isArray(daysField) ? daysField.length : (typeof daysField === 'number' ? daysField : 1);
  const highlightDay = dayCount > 1 ? (day || state.selectedDay) : null;

  const sections = [
    { key: 'access', icon: 'ğŸš—', label: 'ã‚¢ã‚¯ã‚»ã‚¹ãƒ»é§è»Šå ´' },
    { key: 'reception', icon: 'ğŸ“‹', label: 'å—ä»˜' },
    { key: 'start_procedure', icon: 'ğŸ', label: 'ã‚¹ã‚¿ãƒ¼ãƒˆ', alt: 'start' },
    { key: 'competition', icon: 'â±ï¸', label: 'ç«¶æŠ€è¦å‰‡' },
    { key: 'equipment', icon: 'ğŸ‘•', label: 'è£…å‚™' },
    { key: 'emergency', icon: 'ğŸ¥', label: 'ç·Šæ€¥é€£çµ¡å…ˆ' },
    { key: 'facilities', icon: 'ğŸš»', label: 'æ–½è¨­' },
    { key: 'food_and_bath', icon: 'ğŸ½ï¸', label: 'é£Ÿäº‹ãƒ»å…¥æµ´', alt: 'dining' },
  ];
  const skipKeys = new Set(['courses', ...sections.map(s => s.key), ...sections.filter(s => s.alt).map(s => s.alt)]);

  const info = eventData.info;
  let html = '';

  sections.forEach(s => {
    const content = info[s.key] || (s.alt ? info[s.alt] : null);
    if (!content || typeof content !== 'string') return;

    html += `
      <div class="accordion">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span class="acc-icon">${s.icon}</span>
          ${s.label}
          <span class="acc-arrow">â–¼</span>
        </button>
        <div class="accordion-body">${formatInfoText(escapeHtml(content), highlightDay)}</div>
      </div>`;
  });

  // Also render any extra info sections not in the predefined list
  Object.keys(info).forEach(key => {
    if (skipKeys.has(key) || typeof info[key] !== 'string') return;
    html += `
      <div class="accordion">
        <button class="accordion-header" onclick="toggleAccordion(this)">
          <span class="acc-icon">ğŸ“Œ</span>
          ${escapeHtml(key)}
          <span class="acc-arrow">â–¼</span>
        </button>
        <div class="accordion-body">${formatInfoText(escapeHtml(info[key]), highlightDay)}</div>
      </div>`;
  });

  container.innerHTML = html || '<div class="empty-state"><div>æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒç©ºã§ã™</div></div>';
}

function toggleAccordion(header) {
  header.classList.toggle('open');
  const body = header.nextElementSibling;
  if (body) body.classList.toggle('open');
}

/* ========== Rendering: Courses Tab ========== */
function pickDay(value, day) {
  if (!value || typeof value !== 'string') return value || 'â€”';
  const parts = value.split('/').map(s => s.trim());
  if (parts.length >= 2) return parts[day - 1] || parts[0];
  return value;
}

function renderCourses(eventData, selectedClass) {
  const container = document.getElementById('courses-content');
  if (!eventData) {
    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ—ºï¸</div><div>ã‚³ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }

  const dayData = Array.isArray(eventData.days) ? eventData.days[state.selectedDay - 1] : eventData;
  const courses = dayData?.courses || eventData?.info?.courses || eventData.courses || [];
  const daysField = eventData.days || eventData.event?.days;
  const dayCount = Array.isArray(daysField) ? daysField.length : (typeof daysField === 'number' ? daysField : 1);
  const day = state.selectedDay;

  if (!courses.length) {
    container.innerHTML = '<div class="empty-state"><div>ã‚³ãƒ¼ã‚¹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }

  const hasWinTime = courses.some(c => c.winning_time);

  let html = `
    <div class="course-table-wrap">
      <table class="course-table">
        <thead>
          <tr>
            <th>ã‚¯ãƒ©ã‚¹</th>
            <th>è·é›¢</th>
            <th>ç™»è·é›¢</th>
            ${hasWinTime ? '<th>å„ªå‹è¨­å®š</th>' : ''}
            <th>æœ€åˆã®ã‚¹ã‚¿ãƒ¼ãƒˆ</th>
          </tr>
        </thead>
        <tbody>`;

  courses.forEach(c => {
    const className = c.class_name || c['class'] || '';
    const isHighlight = selectedClass && className === selectedClass;
    const dist = dayCount > 1 ? pickDay(c.distance, day) : (c.distance || 'â€”');
    const climb = dayCount > 1 ? pickDay(c.climb, day) : (c.climb || 'â€”');
    const firstStart = dayCount > 1 ? pickDay(c.first_start, day) : (c.first_start || 'â€”');
    const winTime = dayCount > 1 ? pickDay(c.winning_time, day) : (c.winning_time || 'â€”');
    html += `
          <tr${isHighlight ? ' class="highlight"' : ''}>
            <td>${escapeHtml(className)}</td>
            <td>${dist}</td>
            <td>${climb}</td>
            ${hasWinTime ? `<td>${winTime}</td>` : ''}
            <td>${firstStart}</td>
          </tr>`;
  });

  html += '</tbody></table></div>';
  container.innerHTML = html;
}

/* ========== Rendering: Settings Tab ========== */
function renderSettings() {
  const container = document.getElementById('settings-content');
  const events = state.events?.events || [];
  const selectedId = state.selectedEvent || '';
  const participant = state.selectedParticipant;
  const daysField = state.eventData?.days || state.eventData?.event?.days;
  const dayCount = Array.isArray(daysField) ? daysField.length : (typeof daysField === 'number' ? daysField : 1);

  let html = '';

  // Event selector
  html += `
    <div class="setting-group">
      <div class="setting-label">ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠ</div>
      <select id="event-select" onchange="onEventChange(this.value)">
        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        ${events.map(e => `<option value="${e.id}" ${e.id === selectedId ? 'selected' : ''}>${escapeHtml(e.name)}</option>`).join('')}
      </select>
    </div>`;

  // Day selector (only for multi-day events)
  if (dayCount > 1) {
    html += `
      <div class="setting-group">
        <div class="setting-label">æ—¥ç¨‹</div>
        <div class="radio-group">
          ${Array.from({ length: dayCount }, (_, i) => `
            <label>
              <input type="radio" name="day" value="${i + 1}"
                     ${state.selectedDay === i + 1 ? 'checked' : ''}
                     onchange="onDayChange(${i + 1})">
              Day${i + 1}
            </label>`).join('')}
        </div>
      </div>`;
  }

  // Participant
  html += `
    <div class="setting-group">
      <div class="setting-label">å‚åŠ è€…</div>
      ${participant
        ? `<div class="flex-between">
             <span class="participant-badge">${escapeHtml(participant.name || 'æœªé¸æŠ')}</span>
             <button class="btn btn-outline btn-sm" onclick="clearParticipant()">ãƒªã‚»ãƒƒãƒˆ</button>
           </div>`
        : '<div class="meta-text">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¿ãƒ–ã§æ¤œç´¢ãƒ»é¸æŠã§ãã¾ã™</div>'}
    </div>`;

  // Data update
  html += `
    <div class="setting-group">
      <div class="setting-label">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</div>
      <button class="btn btn-green" onclick="refreshData()" id="refresh-btn">
        ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
      </button>
      <div class="meta-text" id="last-updated">æœ€çµ‚æ›´æ–°: æœªå–å¾—</div>
    </div>`;

  // Offline status
  html += `
    <div class="setting-group">
      <div class="setting-label">æ¥ç¶šçŠ¶æ…‹</div>
      <div id="connectivity-status">
        <span class="status-dot offline"></span>
        ç¢ºèªä¸­...
      </div>
      <div class="meta-text">ãƒ‡ãƒ¼ã‚¿ã¯IndexedDBã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¾ã™</div>
    </div>`;

  // Version
  html += `
    <div class="setting-group">
      <div class="setting-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±</div>
      <div class="meta-text">Event Guide v${APP_VERSION}</div>
      <div class="meta-text" style="margin-top:2px;">
        <a href="https://github.com/nao-autonomous/orienteering-event-guide" 
           target="_blank" rel="noopener" style="color:var(--green);">ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</a>
      </div>
    </div>`;

  // Install guide
  html += `
    <div class="setting-group">
      <div class="setting-label">ã‚¢ãƒ—ãƒªã¨ã—ã¦è¿½åŠ </div>
      <div class="meta-text" style="line-height:1.9">
        <strong>iOS Safari:</strong><br>
        1. ä¸‹éƒ¨ã®å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ–¡â†‘ï¼‰ã‚’ã‚¿ãƒƒãƒ—<br>
        2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’<strong>ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</strong><br>
        3.ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—<br><br>
        <strong>Android Chrome:</strong><br>
        å³ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‹®ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€
      </div>
    </div>`;

  // Feedback
  html += `
    <div class="setting-group">
      <div class="setting-label">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>
      <div class="meta-text" style="line-height:1.7">
        ã”æ„è¦‹ãƒ»ã”è¦æœ›ãƒ»ä¸å…·åˆã®å ±å‘Šã¯ã“ã¡ã‚‰
      </div>
      <a href="https://github.com/nao-autonomous/orienteering-event-guide/issues/new"
         target="_blank" rel="noopener"
         class="btn btn-outline" style="margin-top:8px;text-decoration:none;display:inline-flex">
        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚‹
      </a>
    </div>`;

  container.innerHTML = html;
  loadLastUpdated();

  // Check actual connectivity
  checkConnectivity().then(ok => {
    const el = document.getElementById('connectivity-status');
    if (el) {
      el.innerHTML = `<span class="status-dot ${ok ? 'online' : 'offline'}"></span>${ok ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ â€” ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨'}`;
    }
  });
}

async function loadLastUpdated() {
  try {
    const ts = await dbGet('meta', 'last_updated');
    const el = document.getElementById('last-updated');
    if (el && ts) {
      const d = new Date(ts);
      el.textContent = `æœ€çµ‚æ›´æ–°: ${d.toLocaleDateString('ja-JP')} ${d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}`;
    }
  } catch (e) { /* ignore */ }
}

/* ========== Event Handlers ========== */
async function onEventChange(eventId) {
  if (!eventId) return;
  state.selectedEvent = eventId;
  state.selectedDay = 1;
  state.selectedParticipant = null;
  localStorage.setItem('selected_event', eventId);
  localStorage.removeItem('selected_participant');

  showLoading();
  try {
    await loadEventData(eventId);
    updateTopbar();
    renderCurrentTab();
    renderSettings();
  } catch (e) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
  }
}

function onDayChange(day) {
  state.selectedDay = day;
  localStorage.setItem('selected_day', String(day));
  updateDaySelector();
  renderCurrentTab();
}

async function refreshData() {
  const btn = document.getElementById('refresh-btn');
  if (btn) { btn.disabled = true; btn.textContent = 'å–å¾—ä¸­...'; }

  try {
    await loadIndex();
    if (state.selectedEvent) {
      await loadEventData(state.selectedEvent);
    }
    renderCurrentTab();
    renderSettings();
  } catch (e) {
    alert('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—'; }
  }
}

/* ========== Navigation ========== */
function switchTab(tabName) {
  document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

  const panel = document.getElementById(`tab-${tabName}`);
  const navBtn = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
  if (panel) panel.classList.add('active');
  if (navBtn) navBtn.classList.add('active');

  localStorage.setItem('active_tab', tabName);
  renderCurrentTab();
}

function renderCurrentTab() {
  const activePanel = document.querySelector('.tab-panel.active');
  if (!activePanel) return;

  const tabId = activePanel.id;
  const selectedClass = state.selectedParticipant?.class_name || state.selectedParticipant?.['class'] || null;

  switch (tabId) {
    case 'tab-timeline':
      renderTimeline(state.eventData, state.selectedDay, state.selectedParticipant);
      break;
    case 'tab-info':
      renderInfo(state.eventData, state.selectedDay);
      break;
    case 'tab-courses':
      renderCourses(state.eventData, selectedClass);
      break;
    case 'tab-settings':
      renderSettings();
      break;
  }
}

function showLoading() {
  const active = document.querySelector('.tab-panel.active > div');
  if (active) {
    active.innerHTML = '<div class="loading"><div class="spinner"></div><span>èª­ã¿è¾¼ã¿ä¸­...</span></div>';
  }
}

/* ========== Topbar ========== */
function updateTopbar() {
  const titleEl = document.getElementById('topbar-title');
  const ed = state.eventData;
  if (ed) {
    titleEl.textContent = ed.name || ed.event?.name || ed.event_name || 'ã‚¤ãƒ™ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰';
  } else {
    titleEl.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„';
  }
  updateDaySelector();
}

function updateDaySelector() {
  const selectorEl = document.getElementById('day-selector');
  const daysField = state.eventData?.days || state.eventData?.event?.days;
  const dayCount = Array.isArray(daysField) ? daysField.length : (typeof daysField === 'number' ? daysField : 1);

  if (dayCount <= 1) {
    selectorEl.classList.add('hidden');
    selectorEl.innerHTML = '';
    return;
  }

  selectorEl.classList.remove('hidden');
  selectorEl.innerHTML = Array.from({ length: dayCount }, (_, i) =>
    `<button class="day-btn ${state.selectedDay === i + 1 ? 'active' : ''}" 
             onclick="onDayChange(${i + 1})">Day${i + 1}</button>`
  ).join('');
}

/* ========== Utilities ========== */
function escapeHtml(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

/* ========== Initialization ========== */
async function init() {
  // Set up tab navigation
  document.querySelectorAll('.nav-item').forEach(btn => {
    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
  });

  // Open IndexedDB
  try {
    await openDB();
  } catch (e) {
    console.warn('IndexedDB not available:', e);
  }

  // Restore state from localStorage
  state.selectedEvent = localStorage.getItem('selected_event') || null;
  state.selectedDay = parseInt(localStorage.getItem('selected_day') || '1', 10);
  try {
    const savedP = localStorage.getItem('selected_participant');
    if (savedP) state.selectedParticipant = JSON.parse(savedP);
  } catch (e) { /* ignore */ }

  // Load index
  try {
    await loadIndex();
  } catch (e) {
    console.warn('Failed to load index:', e);
  }

  // Load previously selected event
  if (state.selectedEvent && state.events) {
    try {
      await loadEventData(state.selectedEvent);
    } catch (e) {
      console.warn('Failed to load event data:', e);
    }
  }

  // Render
  updateTopbar();
  renderCurrentTab();

  // Also prepare settings tab
  renderSettings();

  // Restore active tab
  const savedTab = localStorage.getItem('active_tab');
  if (savedTab) switchTab(savedTab);

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }

  // Listen for online/offline changes
  window.addEventListener('online', () => renderSettings());
  window.addEventListener('offline', () => renderSettings());

  // Auto-update now marker every minute
  setInterval(() => {
    const active = document.querySelector('.tab-panel.active');
    if (active && active.id === 'tab-timeline') {
      renderTimeline(state.eventData, state.selectedDay, state.selectedParticipant);
    }
  }, 60000);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
